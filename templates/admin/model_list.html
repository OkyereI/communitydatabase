    {% extends 'admin/master.html' %}

    {% block head_tail %}
        {{ super() }}
        {# Corrected: Call macros.style_for_form() as it's defined in macros.html #}
        {{ macros.style_for_form() }} 
    {% endblock %}

    {% block body %}
        <ul class="nav nav-tabs">
            <li class="active">
                <a href="{{ url_for('.index_view') }}">{{ _gettext('List') }}</a>
            </li>
            {% if admin_view.can_create %}
            <li>
                <a href="{{ url_for('.create_view') }}">{{ _gettext('Create') }}</a>
            </li>
            {% endif %}
        </ul>

        {% block model_list_table %}
        <div class="model-list">
            {% block model_list_table_header %}
            {% include 'admin/model_list_table_header.html' %}
            {% endblock %}

            {% block model_list_table_toolbar %}
                {# The toolbar includes the filter dropdown, which now uses url_for #}
                {% include 'admin/model_list_table_toolbar.html' %}
            {% endblock %}

            {# This block for filters should ideally be removed if filters are handled by toolbar #}
            {# However, if it's a separate filter bar, ensure it uses url_for too #}
            {% if filters %}
                {# Corrected: Ensure this section also uses url_for for filter links if it's still present and active #}
                <div class="well well-sm form-inline">
                    <form class="form-filter" method="GET" action="{{ admin_view.get_url('.index_view') }}">
                        {% for flt in filters %}
                            <input type="hidden" name="{{ flt.operation }}" value="{{ flt.value }}">
                        {% endfor %}

                        <div class="form-group">
                            <label for="filter_column">{{ _gettext('Filter') }}:</label>
                            <select id="filter_column" name="flt0_0" class="form-control">
                                <option value="__select__">-- {{ _gettext('Select column') }} --</option>
                                {% for filter_obj in admin_view.column_filters %}
                                <option value="{{ filter_obj.column.name }}" {% if filters.flt0_0 == filter_obj.column.name %}selected{% endif %}>{{ filter_obj.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="filter_op">{{ _gettext('Operation') }}:</label>
                            <select id="filter_op" name="flt0_1" class="form-control">
                                {% for filter_obj in admin_view.column_filters %}
                                    {# ADDED CHECK HERE: Ensure filter_obj.options is not None before iterating #}
                                    {% if filter_obj.options %}
                                        {% for op in filter_obj.options %}
                                            <option class="flt-op-{{ filter_obj.column.name }}" value="{{ op[0] }}" {% if filters.flt0_1 == op[0] and filters.flt0_0 == filter_obj.column.name %}selected{% endif %}>{{ op[1] }}</option>
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="filter_value">{{ _gettext('Value') }}:</label>
                            <input type="text" id="filter_value" name="flt0_2" value="{{ filters.flt0_2 }}" class="form-control" placeholder="{{ _gettext('Filter value') }}">
                        </div>

                        <button type="submit" class="btn btn-default">{{ _gettext('Apply') }}</button>
                    </form>
                </div>
            {% endif %}

            {% block model_list_table_before %}{% endblock %}

            <table class="table table-striped table-bordered table-hover model-list-table">
                <thead>
                    <tr>
                        {# CORRECTED LINE: Call the macro from 'macros' not 'lib' #}
                        {% block list_table_header %}{{ macros.list_table_header(admin_view, model_list, True) }}{% endblock %}
                    </tr>
                </thead>
                <tbody>
                    {% if model_list.items %}
                    {% for row in model_list.items %}
                    <tr>
                        {% block list_table_row_columns %}
                        {{ lib.list_row_actions(admin_view, row) }}
                        {% for c, name in list_columns %}
                            <td class="col-{{ c }}">{% if c in form_columns %}{{ lib.display_property(row, c) }}{% else %}{{ lib.get_value(row, c) }}{% endif %}</td>
                        {% endfor %}
                        {% endblock %}
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="99">
                            {% block empty_list_message %}
                            <div class="text-center">
                                {{ _gettext('No records found.') }}
                            </div>
                        {% endblock %}
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>

            {% block model_list_table_after %}{% endblock %}
        </div>
        {% endblock %}

        {% block model_list_table_pagination %}
        {% include 'admin/model_list_pagination.html' %}
        {% endblock %}
    {% endblock %}
    